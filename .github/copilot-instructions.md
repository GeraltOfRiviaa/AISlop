# AISlop Chat - Copilot Instructions

## Architecture Overview
This is a real-time chat application with persistent user accounts. Core stack: Node.js + Express + Socket.IO, vanilla JS frontend.

**3-tier session model:**
1. **Anonymous `uid` (cookie)** – Generated by server, identifies browser (1-year lifetime)
2. **Account** – Registered nickname + password stored in `data/accounts.json` with key = `nickname.toLowerCase()`
3. **Session binding** – `data/users.json` maps `uid -> nickname` to link browser to logged-in account

**Critical flow:** Bootstrap → Auth check → Socket.IO presence. Unauthenticated users are redirected to `/auth.html` by [client.js](public/client.js#L49-L52).

## Key Files & Responsibilities
- [server.js](server.js) – All backend logic: REST API, Socket.IO events, persistence
- [public/client.js](public/client.js) – Main chat UI, bootstraps session, renders messages
- [public/auth.js](public/auth.js) – Login/register forms, redirects to `/` on success
- [public/settings.js](public/settings.js) – Account settings modal (change nickname/password)
- `data/` – JSON persistence (accounts, users, history); created on first run

## Data Models

### `data/accounts.json`
```js
{ 
  "nickname_lower": {
    "nickname": "ActualCase",  // Display name (preserved case)
    "pw": "salt:scryptHash",   // Hashed with crypto.scrypt
    "id": "uuid",              // Account ID for message attribution
    "createdAt": 1234567890
  }
}
```

### `data/users.json`
```js
{ "browser-uid": "CurrentNickname" }  // Active session bindings
```

### `data/history.json`
```js
[{
  "from": "Nickname",
  "text": "Message (max 500 chars)",
  "at": 1234567890,
  "uid": "browser-uid",
  "accountId": "uuid"
}]  // Last 100 messages (HISTORY_LIMIT)
```

## Code Conventions

### Nickname Handling
**Always use these helpers** from [server.js](server.js#L53-L59):
- `normNick(n)` – Trim whitespace, max 32 chars
- `normKey(n)` – `.toLowerCase()` for account lookup (case-insensitive keys)

**Wrong:** `accounts[nickname]`  
**Right:** `accounts[normKey(nickname)]`

### Password Security
Use [server.js](server.js#L61-L76) crypto functions:
- `hashPassword(pw)` – Returns `"salt:hash"` with `crypto.scrypt`
- `verifyPassword(pw, stored)` – Timing-safe comparison with `crypto.timingSafeEqual`

**Never store plaintext passwords.**

### File Persistence Pattern
Use safe wrappers from [server.js](server.js#L17-L32):
```js
readJsonSafe(file, fallback)   // Returns fallback on error/missing
writeJsonSafe(file, data)      // Pretty-prints with 2-space indent
```
**Critical:** Always `writeJsonSafe` after mutating `accounts`, `users`, or `history`.

### Message Self-Alignment
Frontend uses `accountId` matching to highlight own messages ([client.js](public/client.js#L28-L30)):
```js
const isSelf = (accountId && myAccountId && accountId === myAccountId);
if (isSelf) wrap.classList.add('self');
```
**Never use `uid` for this** – accounts can log in from multiple browsers.

## Development Workflow

### Start Server
```powershell
npm start           # Production
npm run dev         # Watch mode with nodemon
```
**Port:** 3000 (override with `PORT` env var)

### Testing Auth Flow
1. Open incognito window → `/auth.html` → Register
2. Regular window → Login with same nickname
3. Send message from both → Check `.self` class only applies to originating browser's view

### Common Tasks

**Add new REST endpoint:**
```js
app.post('/api/your-endpoint', (req, res) => {
  const uid = req.uid;  // Always available (middleware sets it)
  // Your logic
  res.json({ ok: true });
});
```

**Add new Socket.IO event:**
```js
socket.on('your-event', (data) => {
  // Server-side handler in server.js io.on('connection')
});
```
```js
socket.emit('your-event', payload);  // Client-side in client.js
socket.on('your-event', (data) => { /* handle */ });
```

**Modify history format:** Update migration logic at [server.js](server.js#L37-L44) to backfill new fields.

## Project-Specific Gotchas

1. **Czech UI strings** – All user-facing text is in Czech (error messages, labels)
2. **No frontend framework** – Pure DOM manipulation with helper `el(tag, className, text)` in [client.js](public/client.js#L7-L13)
3. **Single-file backend** – Everything in [server.js](server.js) (no routing separation)
4. **Bootstrap endpoint** – `/api/bootstrap` is called on connect to hydrate client state (username, history, online count)
5. **Logout clears cookie** – [server.js](server.js#L220) calls `res.clearCookie('uid')` to force re-registration

## Security Notes
- Passwords: scrypt + 16-byte salt + timing-safe comparison
- Input limits: 32 chars (nickname), 500 chars (message), 6 chars min (password)
- No rate limiting – add if deploying publicly
- httpOnly cookies prevent XSS theft of `uid`
